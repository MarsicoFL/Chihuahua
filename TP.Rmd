---
title: "Tema"
author: "Franco Marsico & Ailén Authier"
date: "8/26/2021"
output:
  html_document:
    code_folding: show
    theme: paper
    highlight: pygments
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

## Resumen


En el presente trabajo nos concentramos en el análisis de datos haciendo especial enfasis en la visualización y socialización de los resultados de cara a un público no especializado en estadística. A modo de ejemplo tomamos un caso de ciencias forenses, en el cual la investigación conduce a la necesidad de convencer a miembros del poder judicial de la necesidad de exhumar un conjunto de cadáveres para dar con una identificación de una persona desaparecida. En los procedimientos judiciales, el rol del científico forense consiste en la formalización y sistematización de la evidencia y la interpretación de la misma en el contexto de una causa. Esto va desde todos los datos obtenidos relacionados con el hecho, comúnmente denominados como la "investigación preliminar" (Caridi et al., Scientific Reports, 2020) hasta los análisis genéticos de identificación de evidencia a una persona específica o bien análisis de parentesco. En Ciencias Forenses resultan esenciales dos aspectos: transparencia y trazabilidad en los análisis. De esta manera, la visualización de datos acompañada de código abierto resulta propicia a la hora de promover la incorporación de análisis estadísticos a un proceso judicial. 
Con este fin, generamos un ejemplo hipótetico, basado en un caso real, en el cual un análisis de simulación computacional desarrollado con el algoritmo de Monte Carlo resulta elemental para que se tome una decision respecto a un caso. El desafío es trasmitir de forma clara, mantiendo la transparencia y trazabilidad en el análisis y su interpretación, los principales resultados al miembros del poder judicial, no especializados en análisis estadísticos. A continuación se describen detalles del caso, así como los sets de datos generados para realizar el análisis:


# Introducción

```{r, message=FALSE}
library(ggmap)
library(sf)
library(raster)
library(dplyr)
library(spData)
library(spDataLarge)
library(tmap)   
library(leaflet) 
library(ggplot2) 
library(rworldmap) 
library(ggrepel)
library(forrel)
library(ggridges)
library(packHV)
library(plotly)
```


## El contexto
En el año 1993 comenzó un fenómeno de homicidios y desapariciones en la Ciudad de Juarez, Mexico. Para el año 2012 el número de mujeres asesidadas en esta ciudad de frontera, perteneciente al Estado de Chihuahua (ver mapa a continuación), ascendía a más de 700. Aún hoy en día, familiares de las desaparecidas continúan la búsqueda con ayuda de organismos internacionales de Derechos Humanos. 


```{r, message=FALSE}
bbox <- c(left = -118.279, bottom = 17.518, right = -88.352, top = 41.624)

ggmap(get_stamenmap(bbox, zoom = 5)) +
  geom_point(aes(x = -106.487015, y = 31.738581)) +
  geom_text(aes(-106.487015, 32.538581, label = "Ciudad Juarez"))
```
## Los desaparecidos

Basado en un análisis de escaneo terrestre mediante la aplicación de la tecnología LiDAR (previamente utilizado en Campo de Mayo, República Argentina, shorturl.at/uwDE4) se detecta una fosa común en el norte de Ciudad Juarez. Los antropologos forenses determinan que los restos poseen una antiguedad de aproximadamente 20 años, situandonos en una desapación ocurrida entre 1995 y 2005. A dicha altura se habian realizado alrededor de 101 denuncias de personas desaparecidas. Se recopila la información de estos casos constituyendo una base de datos con 101 observaciones y 4 variables (profesión, edad, género y fecha de desaparición).

```{r, message=FALSE}
fecha <- seq(as.Date("1993-01-01"), by =1, len = 365)

genero <- c('M','F')
profesion <- c("Cocinero", "Albañil", "Obrero", "Panadero", "Carpintero", "Locutor",
               "Soldador", "Escritor", "Vendedor", "Sastre", "Repartidor", "Cajero",
               "Carnicero", "Peluquero", "Chofer", "Abogado",	"Médico",	"Paleontólogo",
               "Ingeniero",	"Historiador",	"Geógrafo", "Biólogo",	"Psicólogo",
               "Matemático",	"Arquitecto","Profesor","Periodista", "Físico",	"Sociólogo",
               "Farmacólogo", "Químico",	"Politólogo",	"Enfermero", "Electricista",
               "Bibliotecólogo", "Técnico de sonido",	"Músico", "Filósofo",	"Secretaria",
               "Traductor", "Antropólogo",	"Economista", "Administrador",	"Lingüista",
               "Radiólogo", "Contador")
edad <- (18:65)

set.seed(1)

getFechas <- function(n){
  set.seed(1)
  sample(fecha, n, replace = TRUE)
}

getGenero <- function(n,semilla){
  set.seed(1)
  sample(genero,n,replace = TRUE)
}

getEdad <- function(n,semilla){
  set.seed(1)
  sample(edad,n,replace = TRUE)
}

getProfesion <- function(n,semilla){
  set.seed(1)
  sample(profesion,n,replace = TRUE)
}

genSimulacion <- function(n,semilla){
  desaparecides <- data.frame(profesion = getProfesion(n))
  desaparecides <- cbind(desaparecides, edad = getEdad(n,1))
  desaparecides <- cbind(desaparecides, genero = getGenero(n,1))
 desaparecides <- cbind(desaparecides, fecha = getFechas(n))

    rownames(desaparecides) <- c(1:n)
  return(desaparecides)
}

desaparecides <- genSimulacion(101,1)

```


## La comparación genética
El análisis genético de parentesco se hizo con un total de 101 familias que buscan a sus desaparecidos contra los restos oseos de los 21 individuos hallados. El resultado del análisis se expresa en un cociente de verosimilitud que contrasta dos hipótesis: H1: el resto X corresponde a la persona desaparecida de la familia Y, y H2: el resto X corresponde a un individuo tomado al azar de la población de referencia. El resultado se expresa en LR (likelihood ratio), y su interpretación es la siguiente: suponiendo que un análisis de parentesco arroja un LR = 8, esto indica que es 8 veces más probable obtener los datos genéticos si el individuo X corresponde al pedigrí Y que si correspondiese a una persona tomada al azar de la población de referencia. En total, se realizaron en la investigación 2121 análisis (101 familias por 21 individuos). Esto constituye una base de 2121 resultados (observaciones) con 3 varaibles, Id resto, Id familia y LR. La distribución de valores obtenidos se muestra a continuación.

```{r, message=FALSE}
Resultados <- as.data.frame(cbind(rep(1:21, 101), rep(1:101, each = 21), c(rnorm(2100, mean = 0.01, sd = 0.1), rgamma(21, 3, 3))))
names(Resultados) <- c("Resto", "Familia", "LR")
Resultados$LR[Resultados$LR < 0] <- 0              
summary(Resultados)
```

Graficando dichos resultados observamos un conjunto de valores altos (LR > 1), primeros candidatos para un análisis de mayor profundidad. 

```{r, message=FALSE}
hist_boxplot(Resultados$LR, freq = TRUE, density = FALSE, breaks = 50, main = "Resultados del análisis de parentesco", xlab = "LR", ylab = "Frecuencia")
```

Otra forma de visualizar los datos es utilizando el Log10(LR).
```{r, message=FALSE}
hist(log10(Resultados$LR), freq = TRUE, density = FALSE, breaks = 40, main = "Resultados del análisis de parentesco", xlab = "LR", ylab = "Frecuencia", col = "black")
```


Posteriormente generamos una tabla para identificar a aquellos casos en los cuales el LR > 1. Tomamos este valor como umbral, dado que con un LR > 1 es más probable que la persona en cuestión sea la persona buscada que que no lo sea.

```{r, message=FALSE}
Resultados %>% filter(LR > 1)
```

La familia 101 aparece en todos los casos. A modo de ejemplo analizamos la distribución de LR obtenidos para las familias 1, 10, 100 y 101. Para el plot de densidad utilizamos el Log10(LR).

```{r, message=FALSE}
X <- subset(Resultados, Familia %in% c(1, 10, 100, 101))
library(dplyr)
X <- X %>% mutate(Log = log(LR, 10))

boxplot(Log ~ Familia, data=X)
```

Por este motivo, se decide trabajar específicamente con la Familia 101, cuyo pedigree se muestra a continuación.

```{r, message=FALSE}
x = readFam("Ejemplo.fam", useDVI = T, verbose = FALSE)$Referencia$`Reference pedigree`
x = relabel(x, new = c(1:11)) #relabeling the name of the family members
plot(x, shaded = typedMembers(x))
```
Como se observa, solo hay disponible material genético de familiares lejanos de la persona desaparecida identificada con el número 9 (individuos rayados) correspondientes a una bisabuela (3), una tia-abuela (1) y un primo segundo (2). 
Un análisis de simulaciones permite dar con los valores de LR esperados en un escenario en el cual el individuo a identificar (IA) es realmente 9 versus un escenario en el cual no lo es.

```{r, message=FALSE}
sim <- read.delim("sim.csv")
attach(sim)
TPED = Ejemplo_TP
RPED = Ejemplo_RP
nsimul = 10000

plot(density(log10(as.numeric(unlist(TPED)))), xlab= "log10 (LR)", ylab= "Densidad", 
     col=1, lwd=2, main="", xlim=c(min(log10(RPED))-1,max(log10(TPED)+1)), ylim=c(0,0.7))
points(density(log10(RPED)), col=2, lty=1, lwd=2, type= "l")
  legend("topright", c("H1: IA es 9", "H2: IA no es 9"), 
       lwd=2,lty=1:1, col=1:2)

```
Con esta evaluación es posible dar con un gráfico de falsos positivos versus falsos negativos para cada valor de LR.
´```

Del análisis anterior se desprende que con un LR de 1 existe un 17% de probabilidades de obtener un falso negativo, lo que dejar al conjunto de casos analizados como plausibles de ser identificaciones. La Unidad Fiscal encargada comienza un proceso de búsqueda de familiares vivos y no vivos con el fin de aumentar la capacidad genética del pedigrí. Dentro de un conjunto de opciones se solicita elegir aquella que permita aumentar mayormente la capacidad de detección con al menor cantidad de exhumaciones posibles. Con fines comparativos se introducen dos parámetros: (i) Poder de inclusión: probabilidad de que un indivuduo que realmente sea 9 de un LR > 10.000 (tomado como valor a partir del cual el juzgado considerará al caso resuelto) y (ii) poder de exclusión: probabilidad de que un individuo que no sea 9 de un valor de LR = 0. El código para desarrollar todas estas simulaciones se encuentra abiertamente disponible (Vigeland et al. Forensic Science International Genetics, 2020; Marsico et al., Forensic Science International Genetics, 2021).

```{r, message=FALSE}
#Graficamos el poder estadístico (Poder de Exclusión y Poder de Inclusión). Una de las opciones es simular (condicionalmente) como se modificaría agregando nuevos individuos genotipados. Para seleccionar a quienes se debe modificar la sección sel = list("seleccionado1"; "seleccionado2"; etc). 
sel = list("5", c("6", "8"),"7","6")
#sel = list("5")
simData = MPPsims(x, nProfiles = 10, selections = sel, lrSims = 1, thresholdIP = 10000, seed = 123, missing = "9")
powerPlot(simData, type = 1)

```